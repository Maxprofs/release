<% content_for :page_title, @application.name %>

<div class="page-header">
  <h1 class="remove-bottom-margin">
    <span class="name">Deploy <%= @application.name %></span>
    <span class="shortname">(<%= @application.shortname %>)</span>
  </h1>
  <%= link_to @application.repo_url, @application.repo_url, target: "_blank" %>
</div>

<main>
  <h2>Deployment of <span class="label label-info"><%= @deployment.version %></span></h2>

  <p class="lead add-top-margin">
    To
    <% if @deployment.production? %>
      <span class="label label-danger"><%= @deployment.environment %></span>
    <% else %>
      <span class="label label-default"><%= @deployment.environment %></span>
    <% end %>
    At
    <%= human_datetime(@deployment.created_at) %>
  </p>

  <p>Previous deployment was <%= link_to @previous_deployment.version, deployment_path(@previous_deployment) %> at <%= human_datetime(@previous_deployment.created_at) %></p>

  <p class="pull-right">
    <a class="btn btn-default" href="<%= @application.repo_compare_url(@previous_deployment.version, @deployment.version) %>">
      <i class="glyphicon glyphicon-new-window add-right-margin"></i>Full Diff
    </a>
    <a class="btn btn-default" href="<%= @application.repo_tag_url(@deployment.version) %>">
      <i class="glyphicon glyphicon-new-window add-right-margin"></i>Tag
    </a>
  </p>

  <% if @commits %>
    <p class="lead"><%= @commits.length %> <%= 'commit'.pluralize(@commits.length) %></p>
  <% else %>
  <% end %>

  <% if @github_available %>
    <table class="table table-striped table-bordered table-hover commits" data-module="filterable-table">
      <thead>
        <tr class="table-header">
          <th width="10%">Hash</th>
          <th width="55%">Message</th>
          <th width="20%">Author</th>
          <th width="15%">Date</th>
        </tr>
        <tr class="if-no-js-hide table-header-secondary">
            <td colspan="4">
              <form>
                <label for="table-filter" class="rm">Filter commits</label>
                <input id="table-filter" type="text" class="form-control normal js-filter-table-input" placeholder="Filter commits">
              </form>
            </td>
          </tr>
      </thead>
      <tbody>
        <% @commits.each do |commit| %>
          <tr>
            <td class="hash">
              <%= link_to commit[:sha][0..8], "#{@application.repo_url}/commit/#{commit[:sha]}", target: "_blank" %>
            </td>
            <td class="message">
                <% summary, body = commit[:commit][:message].split(/\n/, 2) %>
                <a href="<%= "#{@application.repo_url}/commit/#{commit[:sha]}" %>" target="_blank"><%= summary %></a>
            </td>
            <td class="author">
              <% if commit[:author] %>
                <img height="20" width="20" class="avatar" src="<%= commit[:author][:avatar_url] %>" alt="" />
              <% end %>
              <% if commit[:commit][:author] %>
                <span class="name">
                  <%= commit[:commit][:author][:name] %>
                </span>
              <% end %>
            </td>
            <td class="date">
              <% if commit[:commit][:author] %>
                <% commit_date = commit[:commit][:author][:date] %>
                <span class="date"><%= commit_date.to_date.to_s(:short) =%></span>
                <span class="time"><%= commit_date.to_s(:govuk_time) =%></span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="alert alert-error">
      Couldn't get data from GitHub:
      <br />
      <%= @github_error %>
    </div>
  <% end %>
</main>
